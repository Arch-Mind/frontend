@startuml ArchMind_State_Diagram

skinparam dpi 100
skinparam stateFontSize 12
skinparam stateAttributeFontSize 10
skinparam arrowFontSize 9
skinparam noteFontSize 9
skinparam stateBorderColor #455A64

title ArchMind - State Diagram\nAnalysis Job Lifecycle

state "Extension States" as extStates #E3F2FD {

  [*] --> Inactive

  state "Inactive" as Inactive #BBDEFB : Extension not activated
  state "Activating" as Activating #BBDEFB : Registering commands\nLoading configuration
  state "Connected" as Connected #BBDEFB : Health check passed\nReady for analysis
  state "Disconnected" as Disconnected #BBDEFB : Backend unreachable\nRetry pending

  Inactive --> Activating : VS Code opens workspace
  Activating --> Connected : Health check 200 OK
  Activating --> Disconnected : Health check failed
  Disconnected --> Connected : Retry success
  Connected --> Disconnected : Connection lost
}

state "Analysis Job States" as jobStates #E8F5E9 {

  state "Idle" as Idle #C8E6C9 : No active analysis\nAwaiting trigger

  state "Submitting" as Submitting #C8E6C9 : POST /api/v1/analyze\nValidating request

  state "Queued" as Queued #FFF9C4 : Job in Redis queue\nWaiting for worker

  state "Processing" as Processing #FFF3E0 {

    state "Cloning" as Cloning #FFE0B2 : git2 clone repository\nfrom GitHub URL

    state "Fingerprinting" as Fingerprinting #FFE0B2 : Computing SHA-256\nfor each file

    state "Parsing" as Parsing #FFE0B2 : tree-sitter extracts\nsymbols and relations

    state "Building Graph" as BuildingGraph #FFE0B2 : Creating nodes and\nedges in Neo4j

    state "Caching" as Caching #FFE0B2 : Storing results\nin Redis cache

    [*] --> Cloning
    Cloning --> Fingerprinting : Clone success
    Fingerprinting --> Parsing : Changed files found
    Fingerprinting --> Caching : No changes detected
    Parsing --> BuildingGraph : Symbols extracted
    BuildingGraph --> Caching : Graph stored in Neo4j
  }

  state "Completed" as Completed #C8E6C9 : Analysis finished\nGraph ready to query

  state "Failed" as Failed #FFCDD2 : Error occurred\nDetails in error_message

  Idle --> Submitting : Developer triggers\nanalyze command
  Idle --> Submitting : GitHub webhook\npush event
  Submitting --> Queued : Validation passed\nJob created in PostgreSQL
  Submitting --> Failed : Invalid URL\nor auth failure
  Queued --> Processing : Worker dequeues\nfrom Redis BRPOP
  Processing --> Completed : All steps successful
  Processing --> Failed : Clone error /\nParse error
  Completed --> Idle : Ready for\nnext analysis
  Failed --> Idle : Error acknowledged\nby developer
}

state "Graph Visualization States" as graphStates #F3E5F5 {

  state "No Graph" as NoGraph #E1BEE7 : No analysis completed\nPanel empty

  state "Loading" as Loading #E1BEE7 : Fetching graph data\nfrom Graph Engine

  state "Rendering" as Rendering #E1BEE7 : ReactFlow processing\nnodes and edges

  state "Interactive" as Interactive #E1BEE7 : Graph displayed\nUser can interact

  state "Refreshing" as Refreshing #E1BEE7 : File changed\nIncremental update

  NoGraph --> Loading : Analysis completed
  Loading --> Rendering : Graph data received
  Loading --> NoGraph : Fetch error
  Rendering --> Interactive : Layout applied\nColors assigned
  Interactive --> Refreshing : File save detected
  Refreshing --> Rendering : Updated data received
  Interactive --> Loading : New analysis triggered
  Interactive --> [*] : Panel closed
}

state "WebView Panel States" as panelStates #FFEBEE {

  state "Closed" as Closed #EF9A9A : No panel open

  state "Initializing" as Initializing #EF9A9A : Loading React app\nand CSS assets

  state "Ready" as Ready #EF9A9A : Panel active\nListening for messages

  state "Zooming" as Zooming #EF9A9A : User zooming\nor panning graph

  state "Searching" as Searching #EF9A9A : Filter applied\nNodes highlighted

  state "Exporting" as Exporting #EF9A9A : Capturing canvas\nas PNG image

  Closed --> Initializing : Command: Show Architecture
  Initializing --> Ready : React mounted
  Ready --> Zooming : Mouse wheel / drag
  Ready --> Searching : Search query entered
  Ready --> Exporting : Export button clicked
  Zooming --> Ready : Zoom complete
  Searching --> Ready : Filter cleared
  Exporting --> Ready : PNG downloaded
  Ready --> Closed : Panel disposed
}

Connected -[hidden]down-> Idle
Completed -[hidden]down-> NoGraph
Interactive -[hidden]down-> Ready

legend right
  |= Color |= State Group |
  | <#E3F2FD> | Extension States |
  | <#E8F5E9> | Job States |
  | <#FFF3E0> | Processing Sub-states |
  | <#F3E5F5> | Graph Visualization |
  | <#FFEBEE> | WebView Panel |
  | <#FFCDD2> | Error / Failed |
endlegend

footer ArchMind - UH4 | State Diagram

@enduml
