@startuml ArchMind_Collaboration_Diagram

skinparam dpi 100
skinparam objectFontSize 11
skinparam objectAttributeFontSize 9
skinparam arrowFontSize 9
skinparam linetype polyline
skinparam objectBorderColor #455A64

title ArchMind - Collaboration Diagram\nMessage Flow Between Components

object "dev : Developer" as dev #E3F2FD
object "ext : VSCodeExtension" as ext #BBDEFB
object "panel : WebViewPanel" as panel #BBDEFB
object "graph : ArchitectureGraph" as agraph #BBDEFB
object "scanner : FileSystemAnalyzer" as scanner #BBDEFB

object "router : APIGateway" as router #C8E6C9
object "analyzeH : AnalyzeHandler" as analyzeH #C8E6C9
object "webhookH : WebhookHandler" as webhookH #C8E6C9

object "consumer : JobConsumer" as consumer #FFE0B2
object "cloner : RepoCloner" as cloner #FFE0B2
object "parser : TreeSitterParser" as parser #FFE0B2
object "fpEngine : FingerprintEngine" as fpEngine #FFE0B2
object "builder : GraphBuilder" as builder #FFE0B2

object "graphSvc : GraphService" as graphSvc #E1BEE7
object "layoutEng : LayoutEngine" as layoutEng #E1BEE7
object "analysisEng : AnalysisEngine" as analysisEng #E1BEE7

object "pg : PostgreSQL" as pg #EF9A9A
object "redis : Redis" as redis #EF9A9A
object "neo4j : Neo4j" as neo4j #EF9A9A

object "gh : GitHub" as gh #F3E5F5

' === Numbered Messages ===

dev --> ext : 1. openWorkspace()
ext --> scanner : 2. scanWorkspace()
scanner --> ext : 3. return fileList, languages
ext --> router : 4. GET /health
router --> ext : 5. return 200 OK

dev --> ext : 6. analyzeRepository(url)
ext --> router : 7. POST /api/v1/analyze
router --> analyzeH : 8. handleAnalyze()
analyzeH --> pg : 9. INSERT analysis_job
analyzeH --> redis : 10. LPUSH job_queue
analyzeH --> ext : 11. return 202 job_id

consumer --> redis : 12. BRPOP job_queue
consumer --> pg : 13. UPDATE status=processing
consumer --> cloner : 14. cloneRepo(url)
cloner --> gh : 15. git2 clone HTTPS
gh --> cloner : 16. return repository files

consumer --> fpEngine : 17. computeFingerprints()
fpEngine --> consumer : 18. return changedFiles list

consumer --> parser : 19. parseFiles(changedFiles)
parser --> consumer : 20. return symbols, relations

consumer --> builder : 21. buildGraph(symbols)
builder --> neo4j : 22. CREATE nodes FileNode, FunctionNode, ClassNode
builder --> neo4j : 23. CREATE edges CALLS, IMPORTS, INHERITS
builder --> pg : 24. UPDATE file_fingerprints
builder --> redis : 25. SETEX analysis_cache

consumer --> pg : 26. UPDATE status=completed

ext --> router : 27. GET /api/v1/jobs/id
router --> pg : 28. SELECT status
router --> ext : 29. return completed

ext --> router : 30. GET /api/v1/graph/repo
router --> graphSvc : 31. forward graph request
graphSvc --> neo4j : 32. MATCH nodes and edges
graphSvc --> layoutEng : 33. applyLayout(nodes, edges)
graphSvc --> analysisEng : 34. detectCircularDeps()
graphSvc --> analysisEng : 35. computeHotspots()
graphSvc --> router : 36. return JSON graph data
router --> ext : 37. return graph response

ext --> panel : 38. postMessage(graphData)
panel --> agraph : 39. renderGraph(nodes, edges)
agraph --> dev : 40. display interactive graph

dev --> agraph : 41. clickNode(nodeId)
agraph --> ext : 42. openFile(path)
ext --> dev : 43. open source file in editor

gh --> router : 44. POST /webhook push event
router --> webhookH : 45. handleWebhook()
webhookH --> webhookH : 46. verifySignature()
webhookH --> pg : 47. INSERT webhook_event
webhookH --> redis : 48. LPUSH job_queue
webhookH --> gh : 49. return 200 OK

legend right
  |= Color |= Component |
  | <#BBDEFB> | VS Code Extension |
  | <#C8E6C9> | API Gateway (Go) |
  | <#FFE0B2> | Ingestion Worker (Rust) |
  | <#E1BEE7> | Graph Engine (Python) |
  | <#EF9A9A> | Databases |
  | <#F3E5F5> | GitHub |
endlegend

footer ArchMind - UH4 | Collaboration Diagram

@enduml
